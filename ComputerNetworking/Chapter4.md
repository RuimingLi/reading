### Chapter 4 网络层：数据平面

网络层能够被分解为两个相互作用的部分：**数据平面** 和**控制平面**

数据平面功能，即网络层中每台路由器的功能，该数据平面功能决定到达路由器输入链路之一的数据报（即网络层的分组）如何转发到该路由器的输出链路之一。

#### 4.1 网络层概述

1. 转发和路由选择：数据平面和控制平面

   转发：是指将分组从一个书输入链路接口转移到适当的输出链路接口的路由器本地动作。时间短（几纳秒），通常用硬件来实现。

   路由选择：是指确定分组从源到目的地所采取的的端到端路径的网络范围处理过程。时间长（几秒），通常用软件来实现。

   控制平面：

   1. 传统方法：由路由器的硬件使用路由选择算法决定插入该转发表的内容

   2. SDN方法：通过计算转发表与路由器交互的远程控制器软件来确定并分发转发表的值

      

2. 网路服务模型

   定义了分组在发送与接收端系统之间的端到端运输特性。

   可能的服务包括：

   * 确保交付
   * 具有时延上界的确保支付
   * 有序分组交付
   * 确保最小带宽
   * 安全性

   因特网的网络层提供了单一的服务，称为**尽力而为服务**。该服务传送的分组既不能保证发送顺序，也不能保证最终交付，既不能保证端到端时延，也不能保证有最小带宽。

#### 4.2路由器工作原理

路由器组件：输入端口、交换结构、输出端口、路由选择处理器

1. 输入端口处理和基于目的地转发：路由器使用转发表来查找输出端口，使得到达的分组能够经过交换结构转发到该端口
2. 交换：通过交换结构，分组才能实际地从一个输入端口交换（即转发）到另一个输出端口。交换有多种方式：经内存交换、经总线交换、经互联网络交换等。
3. 输出端口处理：输出端口处理取出已经存放在输出端口内存中的分组并将其发送到输出链路上。
4. 何时排队：在输入端口和输出端口处都能形成分组队列。输入排队、输出排队
5. 分组调度：先进先出（FIFO）、优先权排队、循环和加权公平排队

#### 4.3 网际协议：IPv4、寻址、IPv6及其他

1. IPv4数据报格式：

   * 版本（号）
   * 首部长度
   * 服务类型
   * 数据报长度
   * 标识、标志、片偏移
   * 寿命
   * 首部检验和
   * 源和目的IP地址
   * 选项
   * 数据（有效载荷）

2. IPv4数据报分片

   一个链路层帧能承受的最大数据量叫*最大传送单元（MTU）*

   片在其到达目的地运输层以前要重新组装

3. IPv4编址

   主机与物理链路之间的边界叫*接口*

   动态主机配置协议（DHCP）

4. 网络地址转换（NAT）

5. IPv6:

   数据报格式：

   * 版本
   * 流量类型
   * 流标签
   * 有效载荷长度
   * 下一个首部
   * 跳限制
   * 源地址和目的地址
   * 数据

   IPv4到IPv6的迁移：

   ​	通过借助于隧道，在隧道发送端的IPv6节点可将整个IPv6数据报放到一个IPv4数据报的数据（有效载荷）字段中

