### Chapter 9 虚拟存储器

为了更加有效的管理内存并减少出错，现代系统提供了一种对贮存的抽象概念，叫做**虚拟内存（VM）**

虚拟内存的三个重要能力：

1. 它将主存看成一个存储在磁盘上的地址空间的高速缓存，在主存中只保存活动区域，并根据需要在磁盘和主存之间来回传送数据，通过这种方式高效地使用主存
2. 它为每个进程提供了一致的地址空间，从而简化了内存管理
3. 它保护了每个进程的地址空间不被其他进程破坏

#### 物理和虚拟寻址

计算机系统的主存被组织成一个由M个连续的字节大小的单元组成的数组。每字节都有一个唯一地物理地址(Physical Address, PA)。第一个字节的地址为0，接下来的字节地址为1，再下一个为2，以此类推。给这种简单的结构，CPU访问内存的最自然的方式就是使用物理地址。这种方式称为物理寻址。 早期的PC使用物理地址，而且诸如数字信号处理器、嵌入式微控制器以及Cray超级计算机这样的系统仍然继续使用这种寻址方式。 使用虚拟寻址，CPU通过生成一个虚拟地址(Virtual Address, VA)来访问主存，这个虚拟地址在被送到内存之前先转换成适当的物理地址。将一个虚拟地址转换为物理地址的任务叫做 地址翻译。就像异常处理一样，地址翻译需要CPU硬件和操作系统之间的紧密合作。CPU芯片上叫做内存管理单元(Memory Management Unit， MMU)的专用硬件，利用存放在主存中的查询表来动态翻译虚拟地址，该表的内容由操作系统管理。

![](https://raw.githubusercontent.com/RuimingLi/reading/master/images/CSAPP/CSAPP-9-2.png)

#### 地址空间

地址空间(address space)是一个非负整数地址的有序集合。

主存中的每字节都有一个选自虚拟地址空 间的虚拟地址和一个选自物理地址空间的物理地址。

#### 虚拟内存作为内存的管理工具

概念上而言，虚拟内存被组织为一个由存放在磁盘上的N个连续的字节大小的单元组成的数组。每字节都有一个唯一的虚拟地址，作为到数组的索引。磁盘上数组的内容被缓存在主存中。和存储器层次结构中其他缓存一样，磁盘(较低层)上 的数据被分割成块，这些块作为磁盘和主存(较高层)之间的传输单元。VM系统通过将虚拟内存分割为称为虚拟页(Virtual Page, VP)的大小固定的块来处理这个问题。每个虚拟页的大小为P=2^p字节。类似地，物理内存被分割为物理页 (Physical Page, PP)，大小也为P字节(物理页也被称为页帧( page frame) ) 

在任意时刻，虚拟页面的集合都分为三个不相交的子集:

* 未分配的: VM系统还未分配(或者创建)的页。未分配的块没有任何数据和它们相关联，因此也就不占用任何磁盘空间

* 缓存的: 当前已缓存在物理内存中的已分配页

* 未缓存的: 未缓存在物理内存中的已分配页

![](https://raw.githubusercontent.com/RuimingLi/reading/master/images/CSAPP/CSAPP-9-3.png)